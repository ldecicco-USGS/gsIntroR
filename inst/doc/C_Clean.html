<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Jeffrey W. Hollister &amp; Luke Winslow" />


<title>C. Clean</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0A%7D%0Apre%20%7B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">C. Clean</h1>
<h4 class="author"><em>Jeffrey W. Hollister &amp; Luke Winslow</em></h4>
<h4 class="date"><em>22 January, 2016</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#quick-links-to-exercises-and-r-code">Quick Links to Exercises and R code</a></li>
<li><a href="#lesson-goals">Lesson Goals</a></li>
<li><a href="#what-is-dplyr">What is <code>dplyr</code>?</a></li>
<li><a href="#subsetting-in-base-r">Subsetting in base R</a></li>
<li><a href="#data-manipulation-in-dplyr">Data Manipulation in <code>dplyr</code></a></li>
<li><a href="#exercise-1">Exercise 1</a></li>
<li><a href="#merging-data">Merging Data</a></li>
<li><a href="#exercise-2">Exercise 2</a></li>
<li><a href="#modify-and-summarize">Modify and Summarize</a></li>
<li><a href="#exercise-3">Exercise 3</a></li>
</ul>
</div>

<table>
<thead>
<tr class="header">
<th align="left">Previous Lesson</th>
<th align="left">Current Lesson</th>
<th align="left">Next Lesson</th>
<th align="left">Workshop Outline</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><a href="B_Get.html">B. Get</a></td>
<td align="left"><a href="C_Clean.html">C. Clean</a></td>
<td align="left"><a href="D_Explore.html">D. Explore</a></td>
<td align="left"><a href="Outline.html">Workshop Outline</a></td>
</tr>
</tbody>
</table>
<p>In this third lesson we are going to start working on maninpulating and cleaning up our data frames. We are spending some time on this because, in my experience, most data analysis and statistics classes seem to assume that 95% of the time spent working with data is on the analysis and interpretation of that analysis and little time is spent getting data ready to analyze. However, in reality, the time spent is flipped with most time spent on cleaning up data and significantly less time on the analysis. We will just be scratching the surface of the many ways you can work with data in R. We will show the basics of subsetting, merging, modifying, and sumarizing data and our examples will all use Hadley Wickham and Romain Francois’ <code>dplyr</code> package. There are many ways to do this type of work in R, many of which are available from base R, but I heard from many (AED colleagues and Hadley himself!) focusing on one way to do this is best, so <code>dplyr</code> it is!</p>
<p>Before we jump into the lesson, quick links and lesson goals are:</p>
<div id="quick-links-to-exercises-and-r-code" class="section level2">
<h2>Quick Links to Exercises and R code</h2>
<ul>
<li><a href="#exercise-1">Exercise 1</a>: Subsetting the Gages data with <code>dplyr</code></li>
<li><a href="#exercise-2">Exercise 2</a>: Merge two Gages data files together.</li>
<li><a href="#exercise-3">Exercise 3</a>: Using <code>dplyr</code> to modify and summarize the Gages.</li>
</ul>
</div>
<div id="lesson-goals" class="section level2">
<h2>Lesson Goals</h2>
<ul>
<li>Show and tell on using base R for data manipulation</li>
<li>Better understand data cleaning through use of <code>dplyr</code></li>
<li>Use <code>merge()</code> to combine data frames by a common key</li>
<li>Do some basic reshaping and summarizing data frames</li>
<li>Know what pipes are and why you might want to use them</li>
</ul>
</div>
<div id="what-is-dplyr" class="section level2">
<h2>What is <code>dplyr</code>?</h2>
<p>The package <code>dplyr</code> is a fairly new (2014) package that tries to provide easy tools for the most common data manipulation tasks. It is built to work directly with data frames. The thinking behind it was largely inspired by the package <code>plyr</code> which has been in use for some time but suffered from being slow in some cases. <code>dplyr</code> addresses this by porting much of the computation to C++. The result is a fast package that gets a lot done with very little code from you.</p>
<p>An additional feature is the ability to work with data stored directly in an external database. The benefits of doing this are that the data can be managed natively in a relational database, queries can be conducted on that database, and only the results of the query returned. This addresses a common problem with R in that all operations are conducted in memory and thus the amount of data you can work with is limited by available memory. The database connections essentially remove that limitation in that you can have a database of many 100s GB, conduct queries on it directly and pull back just what you need for analysis in R.</p>
<p>There is a lot of great info on <code>dplyr</code>. If you have an interest, I’d encourage you to look more. The vignettes are particulary good.</p>
<ul>
<li><a href="https://github.com/hadley/dplyr"><code>dplyr</code> GitHub repo</a></li>
<li><a href="http://cran.rstudio.com/web/packages/dplyr/">CRAN page: vignettes here</a></li>
</ul>
</div>
<div id="subsetting-in-base-r" class="section level2">
<h2>Subsetting in base R</h2>
<p>In base R you can use a indexing to select out rows and columns. You will see this quite often in other people’s code, so I want to at least show it to you.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Create a vector</span>
x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>:<span class="dv">19</span>)
x</code></pre></div>
<pre><code>##  [1] 10 11 12 13 14 15 16 17 18 19</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Positive indexing returns just the value in the ith place</span>
x[<span class="dv">7</span>]</code></pre></div>
<pre><code>## [1] 16</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Negative indexing returns all values except the value in the ith place</span>
x[-<span class="dv">3</span>]</code></pre></div>
<pre><code>## [1] 10 11 13 14 15 16 17 18 19</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Ranges work too</span>
x[<span class="dv">8</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>## [1] 17 18 19</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#A vector can be used to index</span>
<span class="co">#Can be numeric</span>
x[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">6</span>,<span class="dv">10</span>)]</code></pre></div>
<pre><code>## [1] 11 15 19</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Can be boolean - will repeat the pattern </span>
x[<span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">FALSE</span>)]</code></pre></div>
<pre><code>## [1] 10 12 14 16 18</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Can even get fancy</span>
x[x %%<span class="st"> </span><span class="dv">2</span> ==<span class="st"> </span><span class="dv">0</span>]</code></pre></div>
<pre><code>## [1] 10 12 14 16 18</code></pre>
<p>You can also index a data frame or select individual columns of a data frame. Since a data frame has two dimensions, you need to specify an index for both the row and the column. You can specify both and get a single value like <code>data_frame[row,column]</code>, specify just the row and the get the whole row back like <code>data_frame[row,]</code> or get just the column with <code>data_frame[,column]</code>. These examples show that.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Let's use one of the stock data frames in R, iris</span>
<span class="kw">head</span>(iris)</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#And grab a specific value</span>
iris[<span class="dv">1</span>,<span class="dv">1</span>]</code></pre></div>
<pre><code>## [1] 5.1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#A whole column</span>
petal_len&lt;-iris[,<span class="dv">3</span>]
petal_len</code></pre></div>
<pre><code>##   [1] 1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 1.5 1.6 1.4 1.1 1.2 1.5 1.3
##  [18] 1.4 1.7 1.5 1.7 1.5 1.0 1.7 1.9 1.6 1.6 1.5 1.4 1.6 1.6 1.5 1.5 1.4
##  [35] 1.5 1.2 1.3 1.4 1.3 1.5 1.3 1.3 1.3 1.6 1.9 1.4 1.6 1.4 1.5 1.4 4.7
##  [52] 4.5 4.9 4.0 4.6 4.5 4.7 3.3 4.6 3.9 3.5 4.2 4.0 4.7 3.6 4.4 4.5 4.1
##  [69] 4.5 3.9 4.8 4.0 4.9 4.7 4.3 4.4 4.8 5.0 4.5 3.5 3.8 3.7 3.9 5.1 4.5
##  [86] 4.5 4.7 4.4 4.1 4.0 4.4 4.6 4.0 3.3 4.2 4.2 4.2 4.3 3.0 4.1 6.0 5.1
## [103] 5.9 5.6 5.8 6.6 4.5 6.3 5.8 6.1 5.1 5.3 5.5 5.0 5.1 5.3 5.5 6.7 6.9
## [120] 5.0 5.7 4.9 6.7 4.9 5.7 6.0 4.8 4.9 5.6 5.8 6.1 6.4 5.6 5.1 5.6 6.1
## [137] 5.6 5.5 4.8 5.4 5.6 5.1 5.1 5.9 5.7 5.2 5.0 5.2 5.4 5.1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#A row</span>
obs15&lt;-iris[<span class="dv">15</span>,]
obs15</code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 15          5.8           4          1.2         0.2  setosa</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Many rows</span>
obs3to7&lt;-iris[<span class="dv">3</span>:<span class="dv">7</span>,]
obs3to7</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa
## 7          4.6         3.4          1.4         0.3  setosa</code></pre>
<p>Also remember that data frames have column names. We can use those too. Let’s try it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#First, there are a couple of ways to use the column names</span>
iris$Petal.Length</code></pre></div>
<pre><code>##   [1] 1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 1.5 1.6 1.4 1.1 1.2 1.5 1.3
##  [18] 1.4 1.7 1.5 1.7 1.5 1.0 1.7 1.9 1.6 1.6 1.5 1.4 1.6 1.6 1.5 1.5 1.4
##  [35] 1.5 1.2 1.3 1.4 1.3 1.5 1.3 1.3 1.3 1.6 1.9 1.4 1.6 1.4 1.5 1.4 4.7
##  [52] 4.5 4.9 4.0 4.6 4.5 4.7 3.3 4.6 3.9 3.5 4.2 4.0 4.7 3.6 4.4 4.5 4.1
##  [69] 4.5 3.9 4.8 4.0 4.9 4.7 4.3 4.4 4.8 5.0 4.5 3.5 3.8 3.7 3.9 5.1 4.5
##  [86] 4.5 4.7 4.4 4.1 4.0 4.4 4.6 4.0 3.3 4.2 4.2 4.2 4.3 3.0 4.1 6.0 5.1
## [103] 5.9 5.6 5.8 6.6 4.5 6.3 5.8 6.1 5.1 5.3 5.5 5.0 5.1 5.3 5.5 6.7 6.9
## [120] 5.0 5.7 4.9 6.7 4.9 5.7 6.0 4.8 4.9 5.6 5.8 6.1 6.4 5.6 5.1 5.6 6.1
## [137] 5.6 5.5 4.8 5.4 5.6 5.1 5.1 5.9 5.7 5.2 5.0 5.2 5.4 5.1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(iris[<span class="st">&quot;Petal.Length&quot;</span>])</code></pre></div>
<pre><code>##   Petal.Length
## 1          1.4
## 2          1.4
## 3          1.3
## 4          1.5
## 5          1.4
## 6          1.7</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Multiple colums</span>
<span class="kw">head</span>(iris[<span class="kw">c</span>(<span class="st">&quot;Petal.Length&quot;</span>,<span class="st">&quot;Species&quot;</span>)])</code></pre></div>
<pre><code>##   Petal.Length Species
## 1          1.4  setosa
## 2          1.4  setosa
## 3          1.3  setosa
## 4          1.5  setosa
## 5          1.4  setosa
## 6          1.7  setosa</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Now we can combine what we have seen to do some more complex queries</span>
<span class="co">#Get all the data for flowers with a petal length less than 2</span>
little_iris&lt;-iris[iris$Petal.Length&lt;=<span class="dv">2</span>,]
<span class="kw">head</span>(little_iris)</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Or maybe we want just the sepal widths of the virginica species</span>
virginica_iris&lt;-iris$Sepal.Width[iris$Species==<span class="st">&quot;virginica&quot;</span>]
<span class="kw">head</span>(virginica_iris)</code></pre></div>
<pre><code>## [1] 3.3 2.7 3.0 2.9 3.0 3.0</code></pre>
</div>
<div id="data-manipulation-in-dplyr" class="section level2">
<h2>Data Manipulation in <code>dplyr</code></h2>
<p>So, base R can do what you need, but it is a bit complicated and the syntax is a bit dense. In <code>dplyr</code> this can be done with two functions, <code>select()</code> and <code>filter()</code>. The code can be a bit more verbose, but it allows you to write code that is much more readable. Before we start we need to make sure we’ve got everything installed and loaded. If you do not have R Version 3.0.2 or greater you will have some problems (i.e. no <code>dplyr</code> for you).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)</code></pre></div>
<p>I am going to repeat some of what I showed above on data frames but now with <code>dplyr</code>. This is what we will be using in the exercises.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#First, select some columns</span>
dplyr_sel&lt;-<span class="kw">select</span>(iris,Sepal.Length,Petal.Length,Species)
<span class="co">#That's it.  Select one or many columns</span>
<span class="co">#Now select some, like before</span>
dplyr_big_iris&lt;-<span class="kw">filter</span>(iris, Petal.Length&gt;=<span class="dv">6</span>)
<span class="kw">head</span>(dplyr_big_iris)</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 1          6.3         3.3          6.0         2.5 virginica
## 2          7.6         3.0          6.6         2.1 virginica
## 3          7.3         2.9          6.3         1.8 virginica
## 4          7.2         3.6          6.1         2.5 virginica
## 5          7.7         3.8          6.7         2.2 virginica
## 6          7.7         2.6          6.9         2.3 virginica</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Or maybe we want just the virginica species</span>
virginica_iris&lt;-<span class="kw">filter</span>(iris,Species==<span class="st">&quot;virginica&quot;</span>)
<span class="kw">head</span>(virginica_iris)</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 1          6.3         3.3          6.0         2.5 virginica
## 2          5.8         2.7          5.1         1.9 virginica
## 3          7.1         3.0          5.9         2.1 virginica
## 4          6.3         2.9          5.6         1.8 virginica
## 5          6.5         3.0          5.8         2.2 virginica
## 6          7.6         3.0          6.6         2.1 virginica</code></pre>
<p>But what if I wanted to select and filter? There are three ways to do this: use intermediate steps, nested functions, or pipes. With the intermediate steps, you essentially create a temporary data frame and use that as input to the next function. You can also nest functions (i.e. one function inside of another). This is handy, but can be difficult to read if too many functions are nested as the process from inside out. The last option, pipes, are a fairly recent addition to R. Pipes in the unix/linux world are not new and allow you to chain commands together where the output of one command is the input to the next. This provides a more natural way to read the commands in that they are executed in the way you conceptualize it and make the interpretation of the code a bit easier. Pipes in R look like <code>%&gt;%</code> and are made available via the <code>magrittr</code> package, which is installed as part of <code>dplyr</code>. Let’s try all three with the same analysis: selecting out a subset of columns but for only a single species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Intermediate data frames</span>
<span class="co">#Select First: note the order of the output, neat too!</span>
dplyr_big_iris_tmp1 &lt;-<span class="st"> </span><span class="kw">select</span>(iris, Species, Sepal.Length, Petal.Length)
dplyr_big_iris_tmp &lt;-<span class="st"> </span><span class="kw">filter</span>(dplyr_big_iris_tmp1, Petal.Length&gt;=<span class="dv">6</span>)
<span class="kw">head</span>(dplyr_big_iris_tmp)</code></pre></div>
<pre><code>##     Species Sepal.Length Petal.Length
## 1 virginica          6.3          6.0
## 2 virginica          7.6          6.6
## 3 virginica          7.3          6.3
## 4 virginica          7.2          6.1
## 5 virginica          7.7          6.7
## 6 virginica          7.7          6.9</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Nested function</span>
dplyr_big_iris_nest &lt;-<span class="st"> </span><span class="kw">filter</span>(
  <span class="kw">select</span>(iris,Species,Sepal.Length,Petal.Length),
  Species==<span class="st">&quot;virginica&quot;</span>)
<span class="kw">head</span>(dplyr_big_iris_nest)</code></pre></div>
<pre><code>##     Species Sepal.Length Petal.Length
## 1 virginica          6.3          6.0
## 2 virginica          5.8          5.1
## 3 virginica          7.1          5.9
## 4 virginica          6.3          5.6
## 5 virginica          6.5          5.8
## 6 virginica          7.6          6.6</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Pipes</span>
dplyr_big_iris_pipe &lt;-
<span class="st">  </span><span class="kw">select</span>(iris,Species,Sepal.Length,Petal.Length) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Species==<span class="st">&quot;virginica&quot;</span>)
<span class="kw">head</span>(dplyr_big_iris_pipe)</code></pre></div>
<pre><code>##     Species Sepal.Length Petal.Length
## 1 virginica          6.3          6.0
## 2 virginica          5.8          5.1
## 3 virginica          7.1          5.9
## 4 virginica          6.3          5.6
## 5 virginica          6.5          5.8
## 6 virginica          7.6          6.6</code></pre>
</div>
<div id="exercise-1" class="section level2">
<h2>Exercise 1</h2>
<p>This exercise is going to focus on using what we just covered on <code>dplyr</code> to start to clean up the National Lakes Assessment data files. Remember to use the stickies: green when you’re done, red if you have a problem.</p>
<ol style="list-style-type: decimal">
<li>If it isn’t already open, make sure you have the script we created, “usgs_analysis.R” opened up.</li>
<li>Start a new section of code in this script by simply putting in a line or two of comments indicating what it is this set of code does.</li>
<li>Our goal for this is to create two new data frames that represent a subset of the observations as well as a subset of the data.</li>
<li>First, from the <code>gages_cover</code> data frame we want a new data frame that has only the following columns: STAID, DEVNLCD06, FORESTNLCD06, BARRENNLCD06, PASTURENLCD06, and CROPSNLCD06. Name the new data frame <code>gages_cover_subset</code>. Think <code>select()</code></li>
<li>Next, lets subset the water quality data from <code>gages_sites</code>. The columns we want for this are: STAID, STANAME, DRAIN_SQKM, LAT_GAGE, LNG_GAGE, STATE, and COUNTYNAME_SITE. Name the new data frame <code>gages_sites_subset</code>.</li>
<li>Last thing we are going to need to do is get a subset of the observations from <code>gages_sites_subset</code>. We only want streams where STATE equals “NM”. Call it <code>gages_sites_nm</code>.</li>
</ol>
</div>
<div id="merging-data" class="section level2">
<h2>Merging Data</h2>
<p>Joining data in <code>dplyr</code> is accomplished via the various <code>x_join()</code> commands (e.g., <code>inner_join</code>, <code>left_join</code>, <code>anti_join</code>, etc). These are very SQL-esque so if you speak SQL (I am far from fluent!) then these will be pretty easy for you. If not then they aren’t immediately intuitive. For our purposes, the base functions <code>rbind()</code> and <code>merge()</code> are adequate.</p>
<p>We are going to talk about several different ways to do this. First, let’s add some new rows to a data frame. This is very handy as you might have data collected and entered at one time, and then additional observations made later that need to be added. So with <code>rbind()</code> we can stack two data frames with the same columns to store more observations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Let's first create a new small example data.frame</span>
rbind_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a=</span><span class="dv">1</span>:<span class="dv">3</span>, <span class="dt">b=</span><span class="kw">c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;b&quot;</span>,<span class="st">&quot;c&quot;</span>), <span class="dt">c=</span><span class="kw">c</span>(T,T,F), <span class="dt">d=</span><span class="kw">rnorm</span>(<span class="dv">3</span>))
<span class="co">#Now an example df to add</span>
rbind_df2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a=</span><span class="dv">10</span>:<span class="dv">12</span>, <span class="dt">b=</span><span class="kw">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;z&quot;</span>), <span class="dt">c=</span><span class="kw">c</span>(F,F,F), <span class="dt">d=</span><span class="kw">rnorm</span>(<span class="dv">3</span>))
rbind_df &lt;-<span class="st"> </span><span class="kw">rbind</span>(rbind_df, rbind_df2)
rbind_df</code></pre></div>
<pre><code>##    a b     c           d
## 1  1 a  TRUE -0.96193342
## 2  2 b  TRUE -0.29252572
## 3  3 c FALSE  0.25878822
## 4 10 x FALSE -1.15213189
## 5 11 y FALSE  0.19578283
## 6 12 z FALSE  0.03012394</code></pre>
<p>Now something to think about. Could you add a vector as a new row? Why/Why not? When/When not?</p>
<p>Let’s go back to the columns now. There are simple ways to add columns of the same length with observations in the same order to a data frame, but it is very common to have to datasets that are in different orders and have differing numbers of rows. What we want to do in that case is going to be more of a database type function and join two tables based on a common column. A common way to do that in base R is with <code>merge()</code>. So let’s contrive another example by creating a dataset to merge to <code>rbind_df</code> that we created above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Contrived data frame</span>
rbind_df_merge_me &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">a=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">14</span>,<span class="dv">6</span>,<span class="dv">23</span>), <span class="dt">x=</span><span class="kw">rnorm</span>(<span class="dv">7</span>), 
  <span class="dt">names=</span><span class="kw">c</span>(<span class="st">&quot;bob&quot;</span>,<span class="st">&quot;joe&quot;</span>,<span class="st">&quot;sue&quot;</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="st">&quot;jeff&quot;</span>,<span class="ot">NA</span>))
<span class="co"># Create merge of matches</span>
rbind_df_merge_match &lt;-<span class="st"> </span><span class="kw">merge</span>(rbind_df, rbind_df_merge_me, <span class="dt">by=</span><span class="st">&quot;a&quot;</span>)
rbind_df_merge_match</code></pre></div>
<pre><code>##    a b     c          d           x names
## 1  1 a  TRUE -0.9619334  0.08541773   bob
## 2  3 c FALSE  0.2587882  1.11661021   joe
## 3 10 x FALSE -1.1521319 -1.21885742   sue
## 4 11 y FALSE  0.1957828  1.26736872  &lt;NA&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create merge of matches and all of the first data frame</span>
rbind_df_merge_allx &lt;-<span class="st"> </span><span class="kw">merge</span>(rbind_df, rbind_df_merge_me, <span class="dt">by=</span><span class="st">&quot;a&quot;</span>, <span class="dt">all.x=</span><span class="ot">TRUE</span>)
rbind_df_merge_allx</code></pre></div>
<pre><code>##    a b     c           d           x names
## 1  1 a  TRUE -0.96193342  0.08541773   bob
## 2  2 b  TRUE -0.29252572          NA  &lt;NA&gt;
## 3  3 c FALSE  0.25878822  1.11661021   joe
## 4 10 x FALSE -1.15213189 -1.21885742   sue
## 5 11 y FALSE  0.19578283  1.26736872  &lt;NA&gt;
## 6 12 z FALSE  0.03012394          NA  &lt;NA&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># dplyr is faster</span>
rbind_df_merge_allx_dplyr &lt;-<span class="st"> </span><span class="kw">left_join</span>(rbind_df, rbind_df_merge_me, <span class="dt">by=</span><span class="st">&quot;a&quot;</span>)
<span class="kw">all.equal</span>(rbind_df_merge_allx_dplyr, rbind_df_merge_allx)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise 2</h2>
<p>In this exercise we are going to practice merging our Gages data. You will remember that we have two datasets, site information and basin landcover types. We selected some rows out of the site data (based on state) but didn’t select out of the basin landcover table, so we have two data frames, with differing numbers of rows and unknown order. Use your stickies!</p>
<ol style="list-style-type: decimal">
<li>This is the only task we have for this exercise. Add to your script a line (or more if you need it) to create a new data frame, <code>gages_data</code>, that is a merge of <code>gages_sites_nm</code> and <code>gages_cover_subset</code>, but with only lines in <code>gages_sites_nm</code> preserved in the output. The column to merge on is “STAID”</li>
<li>This data frame may have some <code>NA</code> values. For the purposes of these lessons, it is better to remove these. Add another line to your code and create a data frame that removes all NA values from <code>gages_data</code>.</li>
<li>If that goes quickly, feel free to explore <code>rbind()</code> some.</li>
</ol>
</div>
<div id="modify-and-summarize" class="section level2">
<h2>Modify and Summarize</h2>
<p>Now back to <code>dplyr</code>. One area where it really shines is in modifying and summarizing. We will do more here than we did with base, but first let’s walk through one of the examples we did previously, aggregating. We can do this with <code>group_by()</code> and <code>summarize()</code>.</p>
<p>First, we’ll look at an example of grouping a data frame and summarizing the data within those groups.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Chained with Pipes</span>
iris %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(Species) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="kw">mean</span>(Sepal.Length),
            <span class="kw">mean</span>(Sepal.Width),
            <span class="kw">mean</span>(Petal.Length),
            <span class="kw">mean</span>(Petal.Width))</code></pre></div>
<pre><code>## Source: local data frame [3 x 5]
## 
##      Species mean(Sepal.Length) mean(Sepal.Width) mean(Petal.Length)
##       (fctr)              (dbl)             (dbl)              (dbl)
## 1     setosa              5.006             3.428              1.462
## 2 versicolor              5.936             2.770              4.260
## 3  virginica              6.588             2.974              5.552
## Variables not shown: mean(Petal.Width) (dbl)</code></pre>
<p>There are many other functions in <code>dplyr</code> that are useful. Much of what they do, can certainly be accomplished with base R, but not quite as intuitively. Let’s run through some examples with <code>arrange()</code>, <code>slice()</code>, and <code>mutate()</code>.</p>
<p>First <code>arrange()</code> will re-order a data frame based on the values in a specified column. It will take multiple columns and can be in descending or ascending order. I think <code>iris</code> is getting a bit tired, let’s try a different stock data frame this time: <code>mtcars</code>. If you are interested you can try <code>data()</code> to see what is available.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(mtcars)</code></pre></div>
<pre><code>##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># every function, including head(), can be chained</span>
mtcars %&gt;%<span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#ascending order is default</span>
<span class="kw">arrange</span>(mtcars, mpg) %&gt;%<span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>##    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## 1 10.4   8  472 205 2.93 5.250 17.98  0  0    3    4
## 2 10.4   8  460 215 3.00 5.424 17.82  0  0    3    4
## 3 13.3   8  350 245 3.73 3.840 15.41  0  0    3    4
## 4 14.3   8  360 245 3.21 3.570 15.84  0  0    3    4
## 5 14.7   8  440 230 3.23 5.345 17.42  0  0    3    4
## 6 15.0   8  301 335 3.54 3.570 14.60  0  1    5    8</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#descending</span>
<span class="kw">arrange</span>(mtcars, <span class="kw">desc</span>(mpg)) %&gt;%<span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>##    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## 2 32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## 3 30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## 4 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## 5 27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## 6 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#multiple columns: most cyl with best mpg at top</span>
<span class="kw">arrange</span>(mtcars, <span class="kw">desc</span>(cyl), <span class="kw">desc</span>(mpg)) %&gt;%<span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>##    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1 19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## 2 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 3 17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## 4 16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## 5 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 6 15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2</code></pre>
<p>Now <code>slice()</code> which accomplishes what we did with the numeric indices before. Remembering back to that, we could grab rows of the data frame with something like <code>x[3:10,]</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#grab rows 3 through 10</span>
<span class="kw">slice</span>(mtcars, <span class="dv">3</span>:<span class="dv">10</span>)</code></pre></div>
<pre><code>##    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 2 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 3 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 4 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## 5 14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## 6 24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## 7 22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## 8 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4</code></pre>
<p><code>mutate()</code> allows us to add new columns based on expressions applied to existing columns</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mutate</span>(mtcars, <span class="dt">kml=</span>mpg*<span class="fl">0.425</span>) %&gt;%<span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>##    mpg cyl disp  hp drat    wt  qsec vs am gear carb    kml
## 1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 8.9250
## 2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 8.9250
## 3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 9.6900
## 4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 9.0950
## 5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 7.9475
## 6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 7.6925</code></pre>
<p>Lastly, one more function, <code>rowwise()</code> allows us run rowwise, operations. Let’s use a bit of a contrived example for this.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#First a dataset of temperatures, recorded weekly at 100 sites.</span>
temp_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">id=</span><span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">week1=</span><span class="kw">runif</span>(<span class="dv">100</span>,<span class="dv">20</span>,<span class="dv">25</span>), <span class="dt">week2=</span><span class="kw">runif</span>(<span class="dv">100</span>,<span class="dv">19</span>,<span class="dv">24</span>), 
  <span class="dt">week3=</span><span class="kw">runif</span>(<span class="dv">100</span>,<span class="dv">18</span>,<span class="dv">26</span>), <span class="dt">week4=</span><span class="kw">runif</span>(<span class="dv">100</span>,<span class="dv">17</span>,<span class="dv">23</span>))
<span class="kw">head</span>(temp_df)</code></pre></div>
<pre><code>##   id    week1    week2    week3    week4
## 1  1 22.99866 22.18784 25.57801 22.67650
## 2  2 24.55074 21.10012 18.65145 21.93141
## 3  3 22.80212 23.39935 19.88350 22.80066
## 4  4 23.77852 20.60364 20.90038 22.54360
## 5  5 21.89586 20.57656 20.60193 21.55283
## 6  6 21.86640 21.46786 21.33221 20.03100</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#To add row means to the dataset, without the ID</span>
temp_df2 &lt;-<span class="st"> </span>temp_df %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">rowwise</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">site_mean =</span> <span class="kw">mean</span>(<span class="kw">c</span>(week1,week2,week3,week4)))
<span class="kw">head</span>(temp_df2)</code></pre></div>
<pre><code>## Source: local data frame [6 x 6]
## 
##      id    week1    week2    week3    week4 site_mean
##   (int)    (dbl)    (dbl)    (dbl)    (dbl)     (dbl)
## 1     1 22.99866 22.18784 25.57801 22.67650  23.36025
## 2     2 24.55074 21.10012 18.65145 21.93141  21.55843
## 3     3 22.80212 23.39935 19.88350 22.80066  22.22141
## 4     4 23.77852 20.60364 20.90038 22.54360  21.95654
## 5     5 21.89586 20.57656 20.60193 21.55283  21.15679
## 6     6 21.86640 21.46786 21.33221 20.03100  21.17437</code></pre>
<p>We now have quite a few tools that we can use to clean and manipulate data in R. We have barely touched what both base R and <code>dplyr</code> are capable of accomplishing, but hopefully you now have some basics to build on.</p>
<p>Let’s practice some of these last functions with our Gages data.</p>
</div>
<div id="exercise-3" class="section level2">
<h2>Exercise 3</h2>
<p>Next, we’re going to pull in and merge additional water data from NWIS for NM GAGES-II sites. Keep track of your method by adding to your R script and commenting as you go. This exercise has several steps that each depend on the prior one- use your stickies and don’t get frustrated! We’ll work through these one at a time. If you complete a step and notice that your neighbor has not, see if you can answer any questions to help them get it done.</p>
<ol style="list-style-type: decimal">
<li><p>Return to the code chunk in <a href="B_Get.html#reading-nwis-data-into-r">Lesson B. Get</a> that accesses NWIS data. Modify that code chunk and add it to your R script to access phosphorus, temperature (‘00010’), discharge (‘00060’), and specific conductance (‘00095’) for NM. Save these data in data frames named using the variable name and state abbreviation, e.g., ‘discharge_fl’.</p></li>
<li><p>Next, because we are just exploring here, let’s make some assumptions about the variables we have just collected: (a) all of the measurements we have in the data frames are good (i.e., assume none of the comment codes indicate issues with specific data points) and, (b) the only three variables we care about in this data frame are station ID (<code>site_no</code>), measurement date (<code>sample_dt</code>), and value of the measurement made (<code>result_va</code>). These assumptions may <em>not</em> hold for other analyses, but for the purposes of this exercise, we’ll make them. Subset each of the water measurement data frames to include only those three columns each.</p></li>
<li><p>Reformat the columns so their types are compatible for the merge. First, notice that <code>gages_data$STAID</code> is numeric while <code>phos_nm$site_no</code> is the character data type (can you confirm this?). Add this line to pad the STAID values with a preceding 0, which happens to be correct for this dataset, and convert those values to character.</p></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gages_data &lt;-<span class="st"> </span><span class="kw">mutate</span>(gages_data, <span class="dt">STAID=</span><span class="kw">paste0</span>(<span class="st">&quot;0&quot;</span>, <span class="kw">as.character</span>(STAID)))</code></pre></div>
<p>Next, check out the formats of the <code>sample_dt</code> column in the four NWIS variables. They’re not the same! To fix this, just use the following magic formula for now, substituting your variable names in the last four lines if they don’t match mine:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install.packages('lubridate') # this might be necessary for you if you get errors</span>
fix_wq_dates &lt;-<span class="st"> </span>function(wq_dat) {
  wq_dat %&gt;%<span class="st"> </span><span class="kw">mutate</span>(
    <span class="dt">sample_dt =</span> switch(
      <span class="kw">class</span>(sample_dt)[<span class="dv">1</span>],
      <span class="dt">Date =</span> <span class="kw">as.POSIXct</span>(<span class="kw">format</span>(sample_dt, <span class="st">&quot;%Y-%m-%d&quot;</span>), <span class="dt">format=</span><span class="st">&quot;%Y-%m-%d&quot;</span>, <span class="dt">tz=</span><span class="st">&quot;MST7MDT&quot;</span>), 
      <span class="dt">character =</span> <span class="kw">as.POSIXct</span>(sample_dt, <span class="dt">format=</span><span class="st">&quot;%Y-%m-%d&quot;</span>, <span class="dt">tz=</span><span class="st">&quot;MST7MDT&quot;</span>),
      <span class="dt">POSIXct =</span> lubridate::<span class="kw">with_tz</span>(sample_dt, <span class="st">&quot;MST7MDT&quot;</span>)))
}
phos_nm &lt;-<span class="st"> </span><span class="kw">fix_wq_dates</span>(phos_nm)
temp_nm &lt;-<span class="st"> </span><span class="kw">fix_wq_dates</span>(temp_nm)
disch_nm &lt;-<span class="st"> </span><span class="kw">fix_wq_dates</span>(disch_nm)
spcond_nm &lt;-<span class="st"> </span><span class="kw">fix_wq_dates</span>(spcond_nm)</code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li><p>Rename the columns to prepare to merge the data with the ‘gages_data’ data frame. Remember, not all NWIS sites we have collected data from are GAGES-II sites, so we need to merge on a common variable- the columns across the ‘gages_data’ and the water variables that include the site ID should all be named consistently. Second, consider that ‘result_va’ columns are distinct across data frames. Re-name those columns prior to the merge so they reflect the variable included (e.g, ‘result_disch’).</p></li>
<li><p>Merge the data from each of the four variable data frames so they can be easily viewed in a single data frame; this new data frame can be called <code>data_wq</code>. This action should preserve all rows from each of the original data frames.</p></li>
<li><p>Let’s merge the water quality data we have just collected with the GAGES-II sites. Create a new data frame called ‘gages_data_wq’ by merging ‘gages_data’ with the NWIS variables we’ve already collected: phosphorus, temperature, discharge, and specific conductance. In the end, you should have a data frame that includes all rows and columns for GAGES-II sites for NM, in addition to five new columns: ‘sample_dt’, plus the four water quality variables we’re merging. Hint: the number of rows in your expanded ‘gages_data_wq’ data frame will be much longer than in the original ‘gages_data’ data frame, and depending on the frequency of observations made for different variables, some variables may be more sparsely populated than others.</p></li>
</ol>
<table>
<thead>
<tr class="header">
<th align="left">Previous Lesson</th>
<th align="left">Current Lesson</th>
<th align="left">Next Lesson</th>
<th align="left">Workshop Outline</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><a href="B_Get.html">B. Get</a></td>
<td align="left"><a href="C_Clean.html">C. Clean</a></td>
<td align="left"><a href="D_Explore.html">D. Explore</a></td>
<td align="left"><a href="Outline.html">Workshop Outline</a></td>
</tr>
</tbody>
</table>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
